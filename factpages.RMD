---
title: ''
author: ''
date: ''
font: Lato
output:
  html_document:
    self_contained: TRUE
    toc: TRUE
    toc_float: TRUE
    css: www/web_report.css
    editor_options:
      chunk_output_type: console
params:
  state_county: !r c('51013', '06037', '53033', '36061')
---

<style>
@import url('https://fonts.googleapis.com/css?family=Lato&display=swap');
</style>

<link rel='stylesheet' href='//fonts.googleapis.com/css?family=Lato' />

```{r echo = FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(error = TRUE)
knitr::opts_chunk$set(results = 'asis')

```

```{r header-image, fig.width = 5.14, fig.height = 1.46, echo = FALSE}
# All defaults
knitr::include_graphics('www/images/urban-institute-logo.png')

```

```{r setup}
library(here)
library(data.table)
library(gt)
library(tidyverse)
library(glue)
library(rlang)
library(scales)
library(qdapRegex)

options(scipen = 999)

```


```{r set vars}

# set constant variables 

tb_title_size <- 18
tb_title_font <- 'bold'

tb_subtitle_size <- 14
tb_title_font <- 'normal'
tb_font_size <- 12 

source_note_size <- 11
source_note_font <- 'normal'

tb_width_perc <- 80
tb_align <- 'left'

decimal_points <- 2
income_decimal <- 0

income_varlist <- list(
      c(
        'pctl_20', 
        'pctl_50', 
        'pctl_80'
        ), 
      c(
        '20th Percentile', 
        '50th Percentile', 
        '80th Percentile'
      ), 
      c(
        'pctl_20', 
        'pctl_20_ci', 
        'pctl_50', 
        'pctl_50_ci', 
        'pctl_80',
        'pctl_80_ci'
        ), 
      c(
        '20th Percentile', 
        '20th Percentile ci', 
        '50th Percentile', 
        '50th Percentile ci', 
        '80th Percentile', 
        '80th Percentile ci'
      ) 
    )


famstruc_varlist <- list(
  c(
  'famstruc_2par_married', 
  'famstruc_2par_unmarried', 
  'famstruc_1par_plusadults', 
  'famstruc_1par_noadults',
  'famstruc_0par_2adults',	
  'famstruc_0par_other'
  ), 
  c(
  'Two married biological/adoptive parents', 
  'One biological/adoptive parent and that parents current spouse/partner', 
  'One biological/adoptive parent and at least one other adult', 
  'One biological/adoptive parent',
  'Zero biological/adoptive parents, but at least two adults',
  'Other'
), 
  c(
  'famstruc_2par_married', 
  'famstruc_2par_married_ci',
  'famstruc_2par_unmarried', 
  'famstruc_2par_unmarried_ci',
  'famstruc_1par_plusadults', 
  'famstruc_1par_plusadults_ci', 
  'famstruc_1par_noadults',
  'famstruc_1par_noadults_ci',
  'famstruc_0par_2adults',	
  'famstruc_0par_2adults_ci',	
  'famstruc_0par_other',
  'famstruc_0par_other_ci'
  ), 
c(
  'Two married biological/adoptive parents', 
  'Two married biological/adoptive parents ci', 
  'One biological/adoptive parent and that parents current spouse/partner', 
  'One biological/adoptive parent and that parents current spouse/partner ci', 
  'One biological/adoptive parent and at least one other adult', 
  'One biological/adoptive parent and at least one other adult ci', 
  'One biological/adoptive parent',
  'One biological/adoptive parent ci',
  'Zero biological/adoptive parents, but at least two adults',
  'Zero biological/adoptive parents, but at least two adults ci',
  'Other', 
  'Other ci'
) 
)



housing_varlist <- list(
  c(
    'share_affordable_80_ami', 
    'share_affordable_50_ami'
  ), 
  c(
    'Ratio for low-income households', 
    'Ratio for very low-income households' 
  ), 
  c(
    'share_affordable_80_ami', 
    'share_affordable_80_ami_ci', 
    'share_affordable_50_ami',
    'share_affordable_50_ami_ci'
  ), 
  c('Ratio for low-income households', 
    'Ratio for low-income households ci', 
    'Ratio for very low-income households', 
    'Ratio for very low-income households ci' 
  )
)


accuils_varlist <- list(
  c(
    'hpsa_yn'
  ), 
  c(
    'Ranking (0-25, higher = greater shortage)'
  ), 
  c(
    'hpsa_yn',
    'hpsa_yn_ci'
  ), 
  c(
    'Ranking (0-25, higher = greater shortage)',
    'Ranking (0-25, higher = greater shortage) ci'
  )
)

```


```{r read-in-data}
fpath <- 'data/mobility-metrics.csv'
data <- read_csv(fpath, )

metrics_summary <- 'metrics_summary.csv'
m_info <- fread(metrics_summary)

#checking missing 
#summary(data)
#sapply(data, function(x) sum(is.na(x)))


#create unique state-county identifier
data <- data %>% 
  mutate(state = str_pad(state, width = 2, side ='left', pad = '0'), 
         county = str_pad(county, width = 3, side ='left', pad = '0')) %>% 
  unite('state_county', county_name, state_name, sep = ', ', remove = FALSE) %>% 
  unite('full_fips', state, county, sep = '', remove = FALSE) %>% 
  filter(full_fips %in% (params$state_county)) %>% 
  arrange(factor(full_fips, levels = params$state_county)) %>% 
  mutate(state_county = gsub('County', '', state_county)) %>% 
  mutate(state_county = rm_white_comma(state_county))
  
#get the upward county - the first element in the parameter 
upward_county <- data %>% 
  filter(full_fips == params$state_county[1]) %>% 
  select(state_county) %>% 
  pull()

data <- data %>% 
  mutate_if(is.numeric, function(x) {format(round(x, 2), big.mark=",",scientific=FALSE)})

 
```

# `r upward_county`

```{r functions}


quality_value_mapping <- function(input){
  if (input == '1.00') {
    return ('Good')
  } else if (input == '2.00'){
    return ('Marginal')
  } else if (input == '3.00'){
    return ('Poor')
  } else 
    stop("Wrong input for Quality")
}

create_tb <- function(metrics_info_df, dataset, varname_maps){
  
  mb_metrics <- metrics_info_df[3]
  mb_vars  <- metrics_info_df[4][[1]]
  quality_var  <- metrics_info_df[5][[1]]
  metrics_desp  <- metrics_info_df[7]
  data_source <- metrics_info_df[8]
  col_from <- varname_maps[1][[1]]
  col_to <- varname_maps[2][[1]]
  
  dataset %>% 
    select(matches(glue('{mb_vars}|{quality_var}|state_county'))) %>% 
    select(-matches('_lb|_ub')) %>% 
    select(sort(tidyselect::peek_vars())) %>% 
    relocate(!!sym(quality_var), .after = last_col()) %>% 
    rename_at(vars(all_of(col_from)), function(x) col_to) %>% 
    #mutate(!!quality_var := recode(!!quality_var, "1"="Good", "2"="Marginal", "3"="Poor")) %>%  #this line does not work 
    pivot_longer(!state_county, names_to='metrics', values_to='value') %>%   
    pivot_wider(names_from = 'state_county', values_from = 'value') %>% 
    arrange(match(metrics, col_to)) %>% 
    mutate(metrics = gsub('.*_quality', 'Quality', metrics)) %>% 
    select(metrics, everything()) %>% 
    gt(rowname_col = 'metrics') %>% 
    tab_header(
      title = html(glue('<p style="font-weight: bold;">{mb_metrics}</p>')), 
        subtitle = metrics_desp
    ) %>% 
      tab_source_note(str_c('Source:', data_source, sep=' ')) %>% 
      cols_align(
        align = 'left',
        columns = TRUE
     ) %>% 
    cols_align(
      align = 'left',
      columns = TRUE
    ) %>% 
    opt_align_table_header('left') %>% 
    tab_options(
      heading.title.font.size = tb_title_size, 
      heading.subtitle.font.size = tb_subtitle_size, 
      column_labels.font.size = tb_font_size,
      table.font.size = tb_font_size,
      source_notes.font.size = source_note_size, 
      table.width = pct(tb_width_perc), 
      table.align = tb_align)
}


unite_col_values <- function(df, colname_str){

    df <- df %>% 
              unite(!!sym(glue('{colname_str}_ci')), 
                            glue('{colname_str}_lb'), 
                            glue('{colname_str}_ub'), 
                    sep = ', ', 
                    remove=TRUE,
                    na.rm = TRUE) %>% 
      
              mutate_at(vars(matches(glue('{colname_str}_ci'))), function(x) glue('({x})'))
    
    return(df)
}


create_tb_level2 <- function(metrics_info_df, dataset, varname_maps){
    
  mb_metrics <- metrics_info_df[3]
  mb_vars  <- metrics_info_df[4][[1]]
  quality_var  <- metrics_info_df[5][[1]]
  metrics_desp  <- metrics_info_df[7]
  data_source <- metrics_info_df[8]
  
  ci_vars <- metrics_info_df[6]
  
  notes <- metrics_info_df[9]
  col_from <- varname_maps[3][[1]]
  col_to <- varname_maps[4][[1]]

  mb_vars_lst <- colnames(dataset %>% select(setdiff(starts_with(mb_vars), matches('_lb|_ub|_quality'))))

  if (ci_vars == 1){
    
    for (val in mb_vars_lst){      # update this to purrr 
      dataset <- unite_col_values(dataset, val)
    }
    
    ci_str <- 'Confidence Interval'
    
  } else if (ci_vars == 2){
    
    ci_str <- 'Confidence Interval*'   # *CI not available at this time.
    
    # create an empty df      #take this part out as a sep func 
    col_names <- glue('{mb_vars_lst}_ci')
    vec <- vector(mode = 'character', length = nrow(dataset) * length(mb_vars_lst))
    empty_ci_df <- as.data.frame(matrix(vec, c(nrow(dataset), length(mb_vars_lst))))
    colnames(empty_ci_df)[1:length(mb_vars_lst)] <- col_names

    # bind df with '*_ci' columns with original df 
    dataset <- dataset %>% bind_cols(empty_ci_df)
              
  } else if (ci_vars == 3){
    
    ci_str <- 'Confidence Interval+'   # '+CI not applicable.
    
    # create an empty df 
    col_names <- glue('{mb_vars_lst}_ci')
    vec <- vector(mode = 'character', length = nrow(dataset) * length(mb_vars_lst))
    empty_ci_df <- as.data.frame(matrix(vec, c(nrow(dataset), length(mb_vars_lst))))
    colnames(empty_ci_df)[1:length(mb_vars_lst)] <- col_names

    # bind df with '*_ci' columns with original df 
    dataset <- dataset %>% bind_cols(empty_ci_df)
  }
  
  
  test <- dataset %>% 
    select(matches(glue('{mb_vars}|{quality_var}|state_county'))) %>% 
    mutate_all(as.character) %>% 
    relocate(!!sym(quality_var), .after = last_col()) 

  print(colnames(test))
  
  print(test)
  
  print('testing')
  
  print(varname_maps[3])
  print(varname_maps[4])
  test %>% 
    rename_at(vars(col_from), function(x) col_to) %>% 
    pivot_longer(!state_county, names_to='metrics', values_to='value') %>%
    pivot_wider(names_from = 'state_county', values_from = 'value') %>% 
    arrange(match(metrics, col_to)) %>% 
    mutate(metrics = gsub('.*ci', ci_str, metrics)) %>% 
    mutate(metrics = gsub('.*_quality', 'Quality', metrics)) %>% 
    select(metrics, everything()) %>% 
    gt(rowname_col = 'metrics') %>% 
    tab_header(
      title = html(glue('<p style="font-weight: bold;">{mb_metrics}</p>')), 
      subtitle = metrics_desp
    ) %>% 
    tab_source_note(str_c('Source:', data_source, sep=' ')) %>% 
    tab_source_note(str_c('Notes:', notes, sep=' ')) %>% 
    cols_align(
      align = 'left',
      columns = TRUE
   ) %>% 
    cols_align(
      align = 'left',
      columns = TRUE
    ) %>% 
  opt_align_table_header('left') %>% 
  tab_options(
    heading.title.font.size = tb_title_size, 
    heading.subtitle.font.size = tb_subtitle_size, 
    column_labels.font.size = tb_font_size,
    table.font.size = tb_font_size,
    source_notes.font.size = source_note_size, 
    table.width = pct(tb_width_perc), 
    table.align = tb_align) 
} 

```

```{r func2}

get_vars_info <- function(varname, data_summary_file=m_info){
  
  info_lst <- data_summary_file %>% 
    filter(metric_name == varname) %>%
    purrr::transpose() %>% 
    simplify() %>%
    first()
  
  mb_vars <- info_lst[4][[1]]
  
  return(list(info_lst=info_lst, mb_vars=mb_vars))
}

```

## Driver:  Strong and Healthy Families

### Predictors: Financial well-being {.tabset}

#### Summary
```{r income}

m_info_lst <- get_vars_info('Income')

mb_vars <- m_info_lst[4][[1]]

data_sub <- data %>% 
         mutate_at(vars(matches(mb_vars)), function(x) gsub("\\..*","", glue('${x}')))

create_tb(m_info_lst, data_sub, income_varlist) 

```

#### Detail
```{r income detailed}
create_tb_level2(m_info_lst, data_sub, income_varlist)
```


#### Summary
```{r debt}

m_info_lst <- get_vars_info('Financial Security')

mb_vars <- m_info_lst[4][[1]]

data_sub <- data %>% 
         mutate_at(vars(matches(mb_vars)), function(x) gsub("\\..*","", glue('${x}')))

create_tb(m_info_lst, data, income_varlist) 

```

#### Detail
```{r debt}
create_tb_level2(m_info_lst, data_sub, income_varlist)
```


### Housing {.tabset}

#### Summary
```{r housing summary}

m_info_lst <- get_vars_info('Affordable housing')

mb_vars <- m_info_lst[4][[1]]

create_tb(m_info_lst, data, housing_varlist) 

```

#### Detail

```{r housing detailed}

create_tb_level2(m_info_lst, data, housing_varlist)

```

#### Summary
```{r Housing instablity and homelessness}

m_info_lst <- get_vars_info('Housing instablity and homelessness')

mb_vars <- m_info_lst[4][[1]]

create_tb(m_info_lst, data, housing_varlist) 

```

### Family {.tabset}

#### Summary

```{r family summary}


m_info_lst <- get_vars_info('Family structure and stability')

mb_vars <- m_info_lst[4][[1]]


create_tb(m_info_lst, data, famstruc_varlist) 

```

#### Detail

```{r family detailed}

create_tb_level2(m_info_lst, data, famstruc_varlist)

```


### Health

#### Summary 

```{r Access to and utilization of health services}

m_info_lst <- get_vars_info('Access to and utilization of health services')

mb_vars <- m_info_lst[4][[1]]

create_tb(m_info_lst, data, accuils_varlist) 


```

#### Detail

```{r accuils detailed}

create_tb_level2(m_info_lst, data, accuils_varlist) 

```


#### Summary 

```{r Neonatal} 

neonatal_varlist <- list(
  c('lbw'),
  c('% low-weight birth'),
  c(
    'lbw', 
    'lbw_ci'
    ),
  c(
    '% low-weight birth', 
    '% low-weight birth ci')
)

m_info_lst <- get_vars_info('Neonatal Health')$info_lst

create_tb(m_info_lst, data, neonatal_varlist) 

```

#### Detail

```{r Neonatal detailed}

create_tb_level2(m_info_lst, data, neonatal_varlist) 

```

## Driver: Supportive Communities

### Predictors: Local Governance {.tabset}

#### Summary 

```{r election_turnout}

election_turnout_varlist <- list(
  c('election_turnout'),
  c('% voting'),
  c(
    'election_turnout', 
    'election_turnout_ci'
    ),
  c(
    '% voting', 
    '% voting ci')
)

m_info_lst <- get_vars_info('Political Participation')$info_lst

create_tb(m_info_lst, data, election_turnout_varlist) 

```

#### Detail

```{r ele detailed}

create_tb_level2(m_info_lst, data, election_turnout_varlist) 

```

### Neighborhoods {.tabset}

#### Summary 

```{r Economic Inclusion}

econ_inc_varlist <- list(
  c('poverty_exposure'),
  c('% in high poverty neigborhoods'),
  c(
    'poverty_exposure', 
    'poverty_exposure_ci'
    ),
  c(
    '% in high poverty neigborhoods', 
    '% in high poverty neigborhoods ci')
)

m_info_lst <- get_vars_info('Economic Inclusion')$info_lst

create_tb(m_info_lst, data, econ_inc_varlist) 


```

#### Detail

```{r Economic Inclusion}

create_tb_level2(m_info_lst, data, econ_inc_varlist) 

```

#### Summary 

```{r trans transit_trips}

trans_access <- list(
  c('transit_trips'),
  c('Transit trips'),
  c(
    'transit_trips', 
    'transit_trips_ci'
    ),
  c(
    'Transit trips', 
    'Transit trips ci')
)


m_info_lst <- get_vars_info('Transportation access')$info_lst

create_tb(m_info_lst, data, trans_access) 


```


#### Detail

```{r trans transit_trips}

create_tb_level2(m_info_lst, data, trans_access) 


```



#### Summary 

```{r trans cost transit_trips}

trans_cost_varlist <- list(
  c('transit_cost'),
  c('Transit cost'),
  c(
    'transit_cost', 
    'transit_cost_ci'
    ),
  c(
    'Transit cost', 
    'Transit cost ci')
)

m_info_lst <- get_vars_info('Transportation access-cost')$info_lst
mb_vars <- get_vars_info('Transportation access-cost')$mb_vars

data_sub <- data %>% 
  mutate_at(vars(matches(mb_vars), -ends_with('_quality')), function(x) gsub("\\..*","", glue('${x}')))


create_tb(m_info_lst, data_sub, trans_cost_varlist) 

```


#### Detail

```{r trans cost transit_trips}

create_tb_level2(m_info_lst, data_sub, trans_cost_varlist) 

```


#### Summary 

```{r trans cost transit_trips}

env_varlist <- list(
  c('haz_idx'),
  c('AQI'),
  c(
    'haz_idx', 
    'haz_idx_ci'
    ),
  c(
    'AQI', 
    'AQI ci')
)

m_info_lst <- get_vars_info('Environmental Quality')$info_lst

create_tb(m_info_lst, data, env_varlist) 


```


#### Detail

```{r trans cost transit_trips}

create_tb_level2(m_info_lst, data, env_varlist) 


```


### Safety {.tabset}

#### Summary 

#### Detail





## Notes on Data Quality
| 'Good' indicates that the metric is measured with adequate accuracy at sample size.
| 'Marginal' indicates that there are known shortcomings of the data for this metric for this county, and the metric should be used with caution.
| 'Poor' indicates that although the metric could be computed for this county, we have serious concerns about how accurately it is measured for this county and do not recommend its use.


## Additional Notes
| Metrics requiring orginal data collection: 
|    Overall health: Share of adults who rate their own and their childrenâ€™s health as good or excellent
| *Confidence Interval: Confidence interval not available at this time
| +Confidence Interval: Confidence interval not applicable
