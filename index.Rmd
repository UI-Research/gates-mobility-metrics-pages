---
title: ''
author: ''
date: ''
font: Lato
output:
  html_document:
    self_contained: TRUE
    toc: TRUE
    toc_float: TRUE
    css: www/web_report.css
    output_dir: "."
    editor_options:
      chunk_output_type: console
params:
  state_county: !r c('51013', '06037', '53033', '36061')
---

<style>
@import url('https://fonts.googleapis.com/css?family=Lato&display=swap');
</style>

<link rel='stylesheet' href='//fonts.googleapis.com/css?family=Lato' />

```{r echo = FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(error = TRUE)
knitr::opts_chunk$set(results = 'asis')

```

```{r header-image, fig.width = 5.14, fig.height = 1.46, echo = FALSE}
# All defaults
knitr::include_graphics('www/images/urban-institute-logo.png')

```

```{r setup}

library(here)
library(data.table)
library(gt)
library(tidyverse)
library(glue)
library(rlang)
library(scales)
library(qdapRegex)

options(scipen = 999)

```


```{r set vars}

# set constant variables 

tb_title_size <- 18
tb_title_font <- 'bold'

tb_subtitle_size <- 14
tb_title_font <- 'normal'
tb_font_size <- 12 

source_note_size <- 11
source_note_font <- 'normal'

tb_width_perc <- 80
tb_align <- 'left'

decimal_points <- 2
income_decimal <- 0

income_varlist <- list(
  c(
    'pctl_20', 
    'pctl_50', 
    'pctl_80'
  ), 
  c(
    '20th Percentile', 
    '50th Percentile', 
    '80th Percentile'
  ), 
  c(
    'pctl_20', 
    'pctl_20_ci', 
    'pctl_50', 
    'pctl_50_ci', 
    'pctl_80',
    'pctl_80_ci'
  ), 
  c(
    '20th Percentile', 
    '20th Percentile ci', 
    '50th Percentile', 
    '50th Percentile ci', 
    '80th Percentile', 
    '80th Percentile ci'
  ) 
)

```


```{r read-in-data}

fpath <- 'data/mobility-metrics.csv'
data <- read_csv(fpath, )

metrics_summary <- 'metrics_summary.csv'
m_info <- fread(metrics_summary)

m_info <- m_info %>% 
  mutate_at(vars(c('notes', 'metrics_description', 'source_data')), 
            function(x) gsub("&#700;", "'", x)) %>% 
  mutate_at(vars(c('notes', 'metrics_description', 'source_data')), 
            function(x) gsub("\"\"", "\"", x)) 


#checking missing 
#summary(data)
#sapply(data, function(x) sum(is.na(x)))


#create unique state-county identifier
data <- data %>% 
  mutate(state = str_pad(state, width = 2, side ='left', pad = '0'), 
         county = str_pad(county, width = 3, side ='left', pad = '0')) %>% 
  unite('state_county', county_name, state_name, sep = ', ', remove = FALSE) %>% 
  unite('full_fips', state, county, sep = '', remove = FALSE) %>% 
  filter(full_fips %in% (params$state_county)) %>% 
  arrange(factor(full_fips, levels = params$state_county)) %>% 
  mutate(state_county = gsub('County', '', state_county)) %>% 
  mutate(state_county = rm_white_comma(state_county)) 

#get the upward county - the first element in the parameter 
upward_county <- data %>% 
  filter(full_fips == params$state_county[1]) %>% 
  select(state_county) %>% 
  pull()


#convert to percentage 
perc_vars <- c(
  'share_debt_coll', # % with debt
  'homeless_share', # share homeless
  'famstruc_2par_married', # Two married biological/adoptive parents
  'famstruc_1par_noadults', # One biological/adoptive parent and that parent's current spouse/partner
  'famstruc_1par_plusadults', # One biological/adoptive parent and at least one other adult
  'famstruc_0par_2adults', # One biological/adoptive parent
  'famstruc_2par_unmarried', # Two adults, no parent
  'famstruc_0par_other', # Other
  'election_turnout', # % voting 
  'lbw', # % low birthweight
  'white_nh_exposure',
  'black_nh_exposure',
  'hispanic_exposure',
  'poverty_exposure', # % in high poverty
  'frpl40_total', # student poverty concentration
  'frpl40_white', 
  'frpl40_black',
  'frpl40_hispanic', 
  'share_in_preschool', # % in pre k 
  'share_hs_degree' # % with HS degree
)

data <- data %>% 
  mutate_at(perc_vars, 
            function (x) scales::percent(x)) %>% 
  mutate_if(is.numeric, function(x) {format(round(x, 2), big.mark=",",scientific=FALSE)}) %>% 
  mutate(na_quality = 'NA')  %>%  #to be used for metrics where there is no quality variable %>% 
  mutate_at(vars(-one_of('state_county')), function(x) gsub('\\s+', '', x)) %>% 
  rename(hispanic_representation = hispanic,
         hispanic_representation_quality = hispanic_quality) %>% 
  mutate_at(vars(ends_with('_quality')), 
            function(x) recode(x, `1` = 'Good', `2` = 'Marginal', `3` = 'Poor'))

note_ul_bound <- 'Lower/Upper bound'

```

# `r upward_county`

```{r functions}


create_tb <- function(metrics_info_df, dataset, varname_maps){
  
  mb_metrics <- metrics_info_df[3]
  mb_vars  <- metrics_info_df[4][[1]]
  quality_var  <- metrics_info_df[5][[1]]
  metrics_desp  <- metrics_info_df[7]
  data_source <- metrics_info_df[8]
  col_from <- varname_maps[1][[1]]
  col_to <- varname_maps[2][[1]]
  
  temp <- dataset %>% 
    select(matches(glue('{mb_vars}|{quality_var}|state_county'))) %>% 
    select(-matches('_lb|_ub')) %>% 
    select(sort(tidyselect::peek_vars())) %>% 
    rename_at(vars(all_of(col_from)), function(x) col_to) 
  
  if (str_detect(quality_var, '|') == FALSE){ #each variable has its own quality variable  
    
    temp <- temp %>% 
      relocate(!!sym(quality_var), .after = last_col())  
    
  } 
  
  temp %>% 
    pivot_longer(!state_county, names_to='metrics', values_to='value') %>%   
    pivot_wider(names_from = 'state_county', values_from = 'value') %>% 
    arrange(match(metrics, col_to)) %>% 
    mutate(metrics = gsub('.*_quality', 'Quality', metrics)) %>% 
    select(metrics, everything()) %>% 
    gt(rowname_col = 'metrics') %>% 
    tab_header(
      title = '', 
      subtitle = metrics_desp
    ) %>% 
    tab_source_note(str_c('Source:', data_source, sep=' ')) %>% 
    cols_align(
      align = 'left',
      columns = TRUE
    ) %>% 
    cols_align(
      align = 'left',
      columns = TRUE
    ) %>% 
    opt_align_table_header('left') %>% 
    tab_options(
      heading.title.font.size = tb_title_size, 
      heading.subtitle.font.size = tb_subtitle_size, 
      column_labels.font.size = tb_font_size,
      table.font.size = tb_font_size,
      source_notes.font.size = source_note_size, 
      table.width = pct(tb_width_perc), 
      table.align = tb_align) %>% 
    tab_style(
      style = list(
        cell_text(style = "italic")
      ),
      locations = cells_body(
        columns = TRUE,
        rows = metrics == 'Quality')
    )
}


unite_col_values <- function(df, colname_str){
  
  df <- df %>% 
    unite(!!sym(glue('{colname_str}_ci')), 
          glue('{colname_str}_lb'), 
          glue('{colname_str}_ub'), 
          sep = ', ', 
          remove=TRUE,
          na.rm = TRUE) %>% 
    
    mutate_at(vars(matches(glue('{colname_str}_ci'))), function(x) glue('({x})'))
  
  return(df)
}


create_tb_level2 <- function(metrics_info_df, dataset, varname_maps){
  
  mb_metrics <- metrics_info_df[3]
  mb_vars  <- metrics_info_df[4][[1]]
  quality_var  <- metrics_info_df[5][[1]]
  metrics_desp  <- metrics_info_df[7]
  data_source <- metrics_info_df[8]
  ci_vars <- metrics_info_df[6]
  notes <- metrics_info_df[9]
  col_from <- varname_maps[3][[1]]
  col_to <- varname_maps[4][[1]]
  
  mb_vars_lst <- colnames(dataset %>% select(setdiff(matches(mb_vars), matches('_lb|_ub|_quality'))))
  
  
  if (ci_vars == 1){
    
    for (val in mb_vars_lst){      # update this to purrr 
      dataset <- unite_col_values(dataset, val)
    }
    
    ci_str <- 'Confidence Interval'
    
  } else if (ci_vars == 2){
    
    ci_str <- 'Confidence Interval*'   # *CI not available at this time.
    
    # create an empty df      #take this part out as a sep func 
    col_names <- glue('{mb_vars_lst}_ci')
    vec <- vector(mode = 'character', length = nrow(dataset) * length(mb_vars_lst))
    empty_ci_df <- as.data.frame(matrix(vec, c(nrow(dataset), length(mb_vars_lst))))
    colnames(empty_ci_df)[1:length(mb_vars_lst)] <- col_names
    
    # bind df with '*_ci' columns with original df 
    dataset <- dataset %>% bind_cols(empty_ci_df)
    
  } else if (ci_vars == 3){
    
    ci_str <- 'Confidence Interval+'   # '+CI not applicable.
    
    # create an empty df 
    col_names <- glue('{mb_vars_lst}_ci')
    vec <- vector(mode = 'character', length = nrow(dataset) * length(mb_vars_lst))
    empty_ci_df <- as.data.frame(matrix(vec, c(nrow(dataset), length(mb_vars_lst))))
    colnames(empty_ci_df)[1:length(mb_vars_lst)] <- col_names
    
    # bind df with '*_ci' columns with original df 
    dataset <- dataset %>% bind_cols(empty_ci_df)
  }
  
  temp <- dataset %>% 
    select(matches(glue('{mb_vars}|{quality_var}|state_county')), -matches('_lb|ub')) %>% 
    mutate_all(as.character) %>% 
    rename_at(vars(col_from), function(x) col_to)
  
  if (str_detect(quality_var, '|') == FALSE){ #each variable has its own quality variable  
    
    temp <- temp %>% 
      relocate(!!sym(quality_var), .after = last_col())  
    
  } 
  
  temp %>% 
    pivot_longer(!state_county, names_to='metrics', values_to='value') %>%
    pivot_wider(names_from = 'state_county', values_from = 'value') %>% 
    arrange(match(metrics, col_to)) %>% 
    mutate(metrics = gsub('.*ci', ci_str, metrics)) %>% 
    mutate(metrics = gsub('.*_quality', 'Quality', metrics)) %>% 
    select(metrics, everything()) %>% 
    gt(rowname_col = 'metrics') %>% 
    tab_header(
      title = '', 
      subtitle = metrics_desp
    ) %>% 
    tab_source_note(str_c('Source:', data_source, sep=' ')) %>% 
    tab_source_note(str_c('Notes:', notes, sep=' ')) %>% 
    cols_align(
      align = 'left',
      columns = TRUE
    ) %>% 
    cols_align(
      align = 'left',
      columns = TRUE
    ) %>% 
    opt_align_table_header('left') %>% 
    tab_options(
      heading.title.font.size = tb_title_size, 
      heading.subtitle.font.size = tb_subtitle_size, 
      column_labels.font.size = tb_font_size,
      table.font.size = tb_font_size,
      source_notes.font.size = source_note_size, 
      table.width = pct(tb_width_perc), 
      table.align = tb_align) %>% 
    tab_style(
      style = list(
        cell_text(style = "italic")
      ),
      locations = cells_body(
        columns = TRUE,
        rows = metrics == 'Quality')
    )
} 


get_vars_info <- function(varname, data_summary_file=m_info){
  
  info_lst <- data_summary_file %>% 
    filter(metric_name == varname) %>%
    purrr::transpose() %>% 
    simplify() %>%
    first()
  
  mb_vars <- info_lst[4][[1]]
  
  return(list(info_lst=info_lst, mb_vars=mb_vars))
}


```
<br>

## Driver:  Strong and Healthy Families
<br>

### Domain: Financial well-being 

*Visit [here](description.html#domain-financial-well-being) for a thorough description of this domain.*


#### Income {.tabset}

##### Summary
```{r}


income_varlist <- list(
  c(
    'pctl_20', 
    'pctl_50', 
    'pctl_80'
  ), 
  c(
    '20th Percentile', 
    '50th Percentile', 
    '80th Percentile'
  ), 
  c(
    'pctl_20', 
    'pctl_20_ci', 
    'pctl_50', 
    'pctl_50_ci', 
    'pctl_80',
    'pctl_80_ci'
  ), 
  c(
    '20th Percentile', 
    '20th Percentile ci', 
    '50th Percentile', 
    '50th Percentile ci', 
    '80th Percentile', 
    '80th Percentile ci'
  ) 
)


income_m_info_lst <- get_vars_info('Income')$info_lst
mb_vars <- get_vars_info('Income')$mb_vars

data_sub <- data %>% 
  mutate_at(vars(matches(mb_vars), -ends_with('_quality')), 
            function(x) gsub("\\..*","", glue('${x}')))

create_tb(income_m_info_lst, data_sub, income_varlist) 




```
<br>

##### Detail
```{r}

create_tb_level2(income_m_info_lst, data_sub, income_varlist)

```
<br>

#### Financial security {.tabset}

##### Summary
```{r}

debt_varlist <- list(
  c('share_debt_coll'),
  c('% with debt'), 
  c(
    'share_debt_coll', 
    'share_debt_coll_ci'
  ),
  c(
    '% with debt', 
    '% with debt ci')
)

m_info_lst <- get_vars_info('Financial security')$info_lst
mb_vars <- get_vars_info('Financial security')$mb_vars

create_tb(m_info_lst, data, debt_varlist)  



```
<br><br>

##### Detail
```{r}

create_tb_level2(m_info_lst, data, debt_varlist)


```
<br><br>


### Domain: Housing

*Visit [here](description.html#domain-housing) for a thorough description of this domain.*

#### Affordable housing {.tabset}

##### Summary
```{r}


housing_varlist <- list(
  c(
    'share_affordable_80_ami', 
    'share_affordable_50_ami'
  ), 
  c(
    'Ratio for low-income households', 
    'Ratio for very low-income households' 
  ), 
  c(
    'share_affordable_80_ami', 
    'share_affordable_80_ami_ci', 
    'share_affordable_50_ami',
    'share_affordable_50_ami_ci'
  ), 
  c('Ratio for low-income households', 
    'Ratio for low-income households ci', 
    'Ratio for very low-income households', 
    'Ratio for very low-income households ci' 
  )
)

af_m_info_lst <- get_vars_info('Affordable housing')$info_lst

create_tb(af_m_info_lst, data, housing_varlist) 


```
<br>

##### Detail
```{r}

create_tb_level2(af_m_info_lst, data, housing_varlist)


```
<br>


#### Housing instability and homelessness {.tabset}

##### Summary
```{r}

housing_insta_varlist <- list(
  c(
    'homeless_count', 
    'homeless_share'
  ), 
  c(
    'Number homeless',
    'Share homeless'
  ),
  c(
    'homeless_count', 
    'homeless_count_ci', 
    'homeless_share',
    'homeless_share_ci'
  ), 
  c(
    'Number homeless',
    note_ul_bound, 
    'Share homeless',
    'Share homeless ci'
  )
)

m_info_lst <- get_vars_info('Housing instability and homelessness')$info_lst

create_tb(m_info_lst, data, housing_insta_varlist) 


```
<br><br>

##### Detail
```{r}

create_tb_level2(m_info_lst, data, housing_insta_varlist) 


```
<br><br>


### Domain: Family 

*Visit [here](description.html#domain-family-stability) for a thorough description of this domain.*

#### Family structure and stability {.tabset}

##### Summary
```{r}


famstruc_varlist <- list(
  c(
    'famstruc_2par_married', 
    'famstruc_2par_unmarried', 
    'famstruc_1par_plusadults', 
    'famstruc_1par_noadults',
    'famstruc_0par_2adults',	
    'famstruc_0par_other'
  ), 
  c(
    '% 2 married parents', 
    "% 1 parent and that parent's partner", 
    '% 1 parent and 1 other adult', 
    '% 1  parent',
    '% 2 adults, no parent',
    '% Other'
  ), 
  c(
    'famstruc_2par_married', 
    'famstruc_2par_married_ci',
    'famstruc_2par_unmarried', 
    'famstruc_2par_unmarried_ci',
    'famstruc_1par_plusadults', 
    'famstruc_1par_plusadults_ci', 
    'famstruc_1par_noadults',
    'famstruc_1par_noadults_ci',
    'famstruc_0par_2adults',	
    'famstruc_0par_2adults_ci',	
    'famstruc_0par_other',
    'famstruc_0par_other_ci'
  ), 
  c(
    '% 2 married parents', 
    '% 2 married parents ci', 
    "% 1 parent and that parent's partner", 
    "% 1 parent and that parent's partner ci",  
    '% 1 parent and 1 other adult', 
    '% 1 parent and 1 other adult ci', 
    '% 1  parent',
    '% 1  parent ci',
    '% 2 adults, no parent',
    '% 2 adults, no parent ci',
    '% Other', 
    '% Other ci'
  ) 
)

fss_m_info_lst <- get_vars_info('Family structure and stability')$info_lst

create_tb(fss_m_info_lst, data, famstruc_varlist) 


```
<br><br>

##### Detail
```{r}

create_tb_level2(fss_m_info_lst, data, famstruc_varlist)


```
<br><br>


### Domain: Health 

*Visit [here](description.html#domain-health) for a thorough description of this domain.*

#### Access to and utilization of health services {.tabset}

##### Summary

```{r}
accuils_varlist <- list(
  c(
    'hpsa_yn'
  ), 
  c(
    'HPSA'
  ), 
  c(
    'hpsa_yn',
    'hpsa_yn_ci'
  ), 
  c(
    'HPSA',
    'HPSA ci'
  )
)

m_info_lst <- get_vars_info('Access to and utilization of health services')$info_lst

create_tb(m_info_lst, data, accuils_varlist) 
```
<br>

##### Detail

```{r}

create_tb_level2(m_info_lst, data, accuils_varlist) 

```
<br>


#### Neonatal health {.tabset}

##### Summary
```{r}

neonatal_varlist <- list(
  c('lbw'),
  c('% Low-weight birth'),
  c(
    'lbw', 
    'lbw_ci'
  ),
  c(
    '% Low-weight birth', 
    note_ul_bound)
)

nh_m_info_lst <- get_vars_info('Neonatal health')$info_lst

create_tb(nh_m_info_lst, data, neonatal_varlist) 

```
<br><br>

##### Detail
```{r}

create_tb_level2(nh_m_info_lst, data, neonatal_varlist) 

```
<br><br>


## Driver: Supportive Communities
<br>

### Domain: Local Governance 

*Visit [here](description.html#domain-local-governance) for a thorough description of this domain.*

#### Political participation {.tabset}

##### Summary
```{r}

election_turnout_varlist <- list(
  c('election_turnout'),
  c('% voting'),
  c(
    'election_turnout', 
    'election_turnout_ci'
  ),
  c(
    '% voting', 
    '% voting ci')
)

et_m_info_lst <- get_vars_info('Political participation')$info_lst

create_tb(et_m_info_lst, data, election_turnout_varlist) 



```
<br>


##### Detail
```{r}

create_tb_level2(et_m_info_lst, data, election_turnout_varlist) 

```
<br>


#### Descriptive representation among local officials {.tabset}

##### Summary 

```{r}


desp_rep_varlist <- list(
  c('white_nonhispanic',
    'white_nonhispanic_quality',
    'black_nonhispanic',
    'black_nonhispanic_quality', 
    'hispanic_representation',
    'hispanic_representation_quality',
    'asian_other',
    'asian_other_quality'),
  c('Non-Black, Non-Hispanic', 
    'Non-Black, Non-Hispanic_quality', 
    'Black, Non-Hispanic', 
    'Black, Non-Hispanic_quality', 
    'Hispanic', 
    'hispanic_quality',
    'Asian',
    'Asian_quality'
  ),
  c(
    'white_nonhispanic', 
    'white_nonhispanic_ci',
    'white_nonhispanic_quality',
    'black_nonhispanic',
    'black_nonhispanic_ci',
    'black_nonhispanic_quality', 
    'hispanic_representation', 
    'hispanic_representation_ci',
    'hispanic_representation_quality',
    'asian_other', 
    'asian_other_ci',
    'asian_other_quality'
  ),
  c('Non-Black, Non-Hispanic', 
    'Non-Black, Non-Hispanic ci', 
    'Non-Black, Non-Hispanic_quality',
    'Black, Non-Hispanic', 
    'Black, Non-Hispanic ci', 
    'Black, Non-Hispanic_quality', 
    'Hispanic ', 
    'Hispanic ci', 
    'Hispanic_quality',
    'Asian',
    'Asian ci',
    'Asian_quality'
  )
)

m_info_lst <- get_vars_info('Descriptive representation among local officials')$info_lst

create_tb(m_info_lst, data, desp_rep_varlist) 


```
<br><br>

##### Detail 

```{r}

create_tb_level2(m_info_lst, data, desp_rep_varlist) 


```
<br><br>

### Domain: Neighborhoods 

*Visit [here](description.html#domain-neighborhoods) for a thorough description of this domain.*

#### Economic inclusion {.tabset}

##### Summary
```{r}

econ_inc_varlist <- list(
  c('poverty_exposure'),
  c('% in high poverty neighborhoods'),
  c(
    'poverty_exposure', 
    'poverty_exposure_ci'
  ),
  c(
    '% in high poverty neighborhoods', 
    '% in high poverty neighborhoods ci')
)

ei_m_info_lst <- get_vars_info('Economic inclusion')$info_lst

create_tb(ei_m_info_lst, data, econ_inc_varlist) 


```
<br>


##### Detail
```{r}

create_tb_level2(ei_m_info_lst, data, econ_inc_varlist) 


```
<br>


#### Racial diversity {.tabset}

##### Summary
```{r}

race_div <- list(
  c('white_nh_exposure',
    'white_nh_exposure_quality', 
    'black_nh_exposure',
    'black_nh_exposure_quality', 
    'hispanic_exposure',
    'hispanic_exposure_quality'),
  c('% Non-Black, Non-Hispanic', 
    '% Non-Black, Non-Hispanic_quality', 
    '% Black, Non-Hispanic', 
    '% Black, Non-Hispanic_quality', 
    '% Hispanic', 
    '% Hispanic_quality'
  ),
  c('white_nh_exposure',
    'white_nh_exposure_ci',
    'white_nh_exposure_quality', 
    'black_nh_exposure',
    'black_nh_exposure_ci',
    'black_nh_exposure_quality', 
    'hispanic_exposure',
    'hispanic_exposure_ci',
    'hispanic_exposure_quality'),
  c('% Non-Black, Non-Hispanic', 
    '% Non-Black, Non-Hispanic_ci', 
    '% Non-Black, Non-Hispanic_quality',
    '% Black, Non-Hispanic', 
    '% Black, Non-Hispanic_ci',
    '% Black, Non-Hispanic_quality', 
    '% Hispanic', 
    '% Hispanic_ci', 
    '% Hispanic_quality'
  )
)

rd_m_info_lst <- get_vars_info('Racial diversity')$info_lst
create_tb(rd_m_info_lst, data, race_div) 





```
<br>


##### Detail
```{r}

create_tb_level2(rd_m_info_lst, data, race_div) 

```
<br>


#### Transportation access {.tabset}

##### Summary
```{r}

trans_access <- list(
  c('transit_trips'),
  c('Transit trips'),
  c(
    'transit_trips', 
    'transit_trips_ci'
  ),
  c(
    'Transit trips', 
    'Transit trips ci')
)


trans_info_lst <- get_vars_info('Transportation access')$info_lst

create_tb(trans_info_lst, data, trans_access) 


```
<br>

##### Detail
```{r}

create_tb_level2(trans_info_lst, data, trans_access) 


```
<br>

####  {.tabset}

##### Summary
```{r}


trans_cost_varlist <- list(
  c('transit_cost'),
  c('Transit cost'),
  c(
    'transit_cost', 
    'transit_cost_ci'
  ),
  c(
    'Transit cost', 
    'Transit cost ci')
)

tr_cost_m_info_lst <- get_vars_info('Transportation access-cost')$info_lst

create_tb(tr_cost_m_info_lst, data, trans_cost_varlist) 



```
<br>


##### Detail
```{r}

create_tb_level2(tr_cost_m_info_lst, data, trans_cost_varlist) 


```
<br>


#### Environmental quality {.tabset}

##### Summary
```{r}


env_varlist <- list(
  c('haz_idx'),
  c('Air quality index'),
  c(
    'haz_idx', 
    'haz_idx_ci'
  ),
  c(
    'Air quality index', 
    'Air quality index ci')
)

env_m_info_lst <- get_vars_info('Environmental quality')$info_lst

create_tb(env_m_info_lst, data, env_varlist)




```
<br><br>


##### Detail
```{r}

create_tb_level2(env_m_info_lst, data, env_varlist) 

```
<br><br>



### Domain: Safety

*Visit [here](description.html#domain-safety) for a thorough description of this domain.*

#### Exposure to crime {.tabset}

##### Summary
```{r}


exp_crime_varlist <- list(
  c(
    'violent_crime_rate',
    'property_crime_rate'
  ),
  c(
    'Violent crime', 
    'Property crime'
  ),
  c(
    'violent_crime_rate',
    'violent_crime_rate_ci', 
    'property_crime_rate',
    'property_crime_rate_ci'
  ),
  c(
    'Violent crime', 
    'Violent crime ci', 
    'Property crime', 
    'Property crime ci'
  )
)

ec_m_info_lst <- get_vars_info('Exposure to crime')$info_lst
mb_vars <- get_vars_info('Exposure to crime')$mb_vars

data_sub_exp_crime <- data %>% 
  mutate_at(vars(matches(mb_vars), -ends_with('_quality')), 
            function(x) gsub("\\..*","", x))

create_tb(ec_m_info_lst, data_sub_exp_crime, exp_crime_varlist) 


```
<br>


##### Detail
```{r}

create_tb_level2(ec_m_info_lst, data_sub_exp_crime, exp_crime_varlist) 


```
<br>

#### Overly punitive policing {.tabset}

##### Summary
```{r}


punative_policing <- list(
  c('juvenile_arrest_rate'),
  c('Juvenile arrests'),
  c(
    'juvenile_arrest_rate', 
    'juvenile_arrest_rate_ci'
  ),
  c(
    'Juvenile arrests', 
    'Juvenile arrests ci')
)

m_info_lst <- get_vars_info('Overly punitive policing')$info_lst
mb_vars <- get_vars_info('Overly punitive policing')$mb_vars

data_sub_punitive <- data %>% 
  mutate_at(vars(matches(mb_vars), -ends_with('_quality')), 
            function(x) gsub("\\..*","", x))

create_tb(m_info_lst, data_sub_punitive, punative_policing) 



```
<br><br>


##### Detail
```{r}

create_tb_level2(m_info_lst, data_sub_punitive, punative_policing) 


```
<br><br>



## Driver: Earn and learn
<br>

### Domain: Education

*Visit [here](description.html#domain-education) for a thorough description of this domain.*

#### Access to preschool {.tabset}

##### Summary
```{r}

share_in_presch_varlist <- list(
  c('share_in_preschool'),
  c('% Pre-kindergarden'),
  c(
    'share_in_preschool', 
    'share_in_preschool_ci'
  ),
  c(
    '% Pre-kindergarden', 
    '% Pre-kindergarden ci')
)

ap_m_info_lst <- get_vars_info('Access to preschool')$info_lst

create_tb(ap_m_info_lst, data, share_in_presch_varlist) 



```
<br>


##### Detail
```{r}

create_tb_level2(ap_m_info_lst, data, share_in_presch_varlist) 


```
<br>

#### Effective public education {.tabset}

##### Summary
```{r}

eff_pub_ed <- list(
  c('learning_rate'),
  c('Annual ELA achievement'),
  c(
    'learning_rate', 
    'learning_rate_ci'
  ),
  c(
    'Annual ELA achievement', 
    note_ul_bound)
)


epd_m_info_lst <- get_vars_info('Effective public education')$info_lst
create_tb(epd_m_info_lst, data, eff_pub_ed) 

```
<br>


##### Detail
```{r}


create_tb_level2(epd_m_info_lst, data, eff_pub_ed) 

```
<br>


#### Student poverty concentration {.tabset}

##### Summary
```{r}

stu_poverty <- list(
  c('frpl40_white', 
    'frpl40_white_quality',
    'frpl40_black',
    'frpl40_black_quality',
    'frpl40_hispanic', 
    'frpl40_hispanic_quality'
  ),
  c(
    '% White, non-Hispanic', 
    '% White, non-Hispanic_quality',
    '% Black, non-Hispanic', 
    '% Black, non-Hispanic_quality', 
    '% Hispanic', 
    '% Hispanic_quality'
  ),
  c('frpl40_white', 
    'frpl40_white_ci', 
    'frpl40_white_quality',
    'frpl40_black',
    'frpl40_black_ci', 
    'frpl40_black_quality',
    'frpl40_hispanic', 
    'frpl40_hispanic_ci',
    'frpl40_hispanic_quality'
  ),
  c(
    '% White, non-Hispanic', 
    '% White, non-Hispanic_ci', 
    '% White, non-Hispanic_quality',
    '% Black, non-Hispanic', 
    '% Black, non-Hispanic_ci',
    '% Black, non-Hispanic_quality', 
    '% Hispanic', 
    '% Hispanic_ci',
    '% Hispanic_quality'
  )
)


spoverty_m_info_lst <- get_vars_info('Student poverty concentration')$info_lst

create_tb(spoverty_m_info_lst, data, stu_poverty) 



```
<br>


##### Detail
```{r}


create_tb_level2(spoverty_m_info_lst, data, stu_poverty) 

```
<br>


#### College readiness {.tabset}

##### Summary
```{r}


college_readiness <- list(
  c('share_hs_degree'),
  c('% HS degree'),
  c(
    'share_hs_degree', 
    'share_hs_degree_ci'
  ),
  c(
    '% HS degree', 
    '% HS degree ci')
)

m_info_lst <- get_vars_info('College readiness')$info_lst
create_tb(m_info_lst, data, college_readiness) 

```
<br><br>


##### Detail
```{r}

create_tb_level2(m_info_lst, data, college_readiness) 


```
<br><br>


### Domain: Work

*Visit [here](description.html#domain-work) for a thorough description of this domain.*

#### Employment {.tabset}

##### Summary
```{r}


emp_lst <- list(
  c('share_employed'),
  c('Employment to population ratio'),
  c(
    'share_employed', 
    'share_employed_ci'
  ),
  c(
    'Employment to population ratio', 
    'Employment to population ratio ci')
)


emp_m_info_lst <- get_vars_info('Employment')$info_lst

create_tb(emp_m_info_lst, data, emp_lst) 


```
<br>


##### Detail
```{r}

create_tb_level2(emp_m_info_lst, data, emp_lst) 


```
<br>


#### Access to jobs paying a living wage {.tabset}

##### Summary
```{r}

job_wage <- list(
  c('average_to_living_wage_ratio'),
  c('Ratio of pay to living wage'),
  c(
    'average_to_living_wage_ratio', 
    'average_to_living_wage_ratio_ci'
  ),
  c(
    'Ratio of pay to living wage', 
    'Ratio of pay to living wage ci')
)


m_info_lst <- get_vars_info('Access to jobs paying a living wage')$info_lst

create_tb(m_info_lst, data, job_wage) 


```
<br><br>


##### Detail
```{r}

create_tb_level2(m_info_lst, data, job_wage) 

```
<br><br>


## Notes on Data Quality
| "Good" indicates that the metric is measured with adequate accuracy at sample size.
| "Marginal" indicates that there are known shortcomings of the data for this metric for this county, and the metric should be used with caution.
| "Poor" indicates that although the metric could be computed for this county, we have serious concerns about how accurately it is measured for this county and do not recommend its use.

<br><br>

## Additional Notes
| The following metrics require orginal data collection: 
|    Overall health: Share of adults who rate their own and their children’s health as good or excellent
|    Belonginess: Inclusion of other in the self scale
|    Social Capital: Social capital community benchmark scale
|    Exposure to Trauma: Adverse childhood experiences scale
<br>

| * This confidence interval not available at this time.
| + A confidence interval not applicable.
| Lower/Upper bound:  The data used to construct this metric do not lend themselves to conventional confidence intervals. The value of the metric shown represents are best estimate; the lower and upper bounds represent alternative estimates of the metric under different assumptions about missing data.




