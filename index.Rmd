---
title: ''
author: ''
date: ''
font: Lato
output:
  html_document:
    self_contained: TRUE
    toc: TRUE
    toc_float: TRUE
    mathjax: null
    css: www/web_report.css
    output_dir: "."
    editor_options:
      chunk_output_type: console
params:
  state_county: !r c('42077', '42095', '42017', '48453', '09003')
  fake_labels: FALSE
---

```{r echo = FALSE}

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(error = TRUE)
knitr::opts_chunk$set(results = 'asis')

```

```{r header-image, fig.width = 5.14, fig.height = 1.46, echo = FALSE}

# All defaults
knitr::include_graphics(here::here('www', 'images', 'urban-institute-logo.png'))

```

```{r setup}

library(here)
library(data.table)
library(gt)
library(tidyverse)
library(glue)
library(rlang)
library(scales)
library(qdapRegex)

options(scipen = 999)

```


```{r set vars}

# set constant variables 

tb_title_size <- 18
tb_title_font <- 'bold'

tb_subtitle_size <- 14
tb_title_font <- 'normal'
tb_font_size <- 12 

source_note_size <- 11
source_note_font <- 'normal'

tb_width_perc <- 80
tb_align <- 'left'

decimal_points <- 2
income_decimal <- 0


# Get a list of all variables that should be presented as percentage 
perc_vars <- c(
  'share_debt_coll', # % with debt
  'homeless_share', # share homeless
  'famstruc_2par_married', # Two married biological/adoptive parents
  'famstruc_1par_noadults', # One biological/adoptive parent and that parent's current spouse/partner
  'famstruc_1par_plusadults', # One biological/adoptive parent and at least one other adult
  'famstruc_0par_2adults', # One biological/adoptive parent
  'famstruc_2par_unmarried', # Two adults, no parent
  'famstruc_0par_other', # Other
  'election_turnout', # % voting 
  'lbw', # % low birthweight
  'white_nh_exposure',
  'black_nh_exposure',
  'hispanic_exposure',
  'poverty_exposure', # % in high poverty
  'frpl40_total', # student poverty concentration
  'frpl40_white', 
  'frpl40_black',
  'frpl40_hispanic', 
  'share_in_preschool', # % in pre k 
  'share_hs_degree', 
  'share_employed' # % with HS degree
)


```


```{r read-in-data}

subdir <- 'mobility-metrics'
fpath_race_ethnicity <- glue('{subdir}/02_mobility-metrics_race-ethnicity.csv')
fpath_race <- glue('{subdir}/03_mobility-metrics_race.csv')
fpath_race_share <- glue('{subdir}/04_mobility-metrics_race-share.csv')

my_col_type <- cols(state=col_character(), county = col_character())

data <- bind_rows(list(race_ethnicity=read_csv(fpath_race_ethnicity, col_types = my_col_type), 
                       race=read_csv(fpath_race, col_types = my_col_type), 
                       race_share=read_csv(fpath_race_share, col_types = my_col_type)), .id='subgroup_id') %>%
  mutate(state = str_pad(state, width = 2, side ='left', pad = '0'), #set max ub as 1 
         county = str_pad(county, width = 3, side ='left', pad = '0'))


# fix a few data issues
  data <- data %>%
    mutate(
      juvenile_arrest_rate = if_else(state == "12", as.numeric(NA), juvenile_arrest_rate),
      crime_rate_quality = case_when(
        state == "36" & county %in% c("005", "047", "081", "085", "061") ~ 1,
        crime_rate_quality == 1 ~ 2,
        TRUE ~ crime_rate_quality
      )
    )


if (params$fake_labels) {
  
  data <- data %>%
    mutate(state_county = paste0(state, county)) %>%
    mutate(county_name =
             case_when(
               state_county == params$state_county[1] ~ "Upward County County",
               state_county == params$state_county[2] ~ "Peer 1",
               state_county == params$state_county[3] ~ "Peer 2",
               state_county == params$state_county[4] ~ "Peer 3",
             )
    )
  
  data <- data %>%
    mutate(state_name = "MB") 
}


metrics_summary <- 'metrics_summary.csv'
m_info <- fread(metrics_summary)

m_info <- m_info %>% 
  mutate_at(vars(c('notes', 'metrics_description', 'source_data')), 
            function(x) gsub("&#700;", "'", x)) %>% 
  mutate_at(vars(c('notes', 'metrics_description', 'source_data')), 
            function(x) gsub("\"\"", "\"", x)) 



#create unique state-county identifier
data <- data %>% 
  mutate_at(vars(matches('share_affordable_')),  #for affordable housing variables, multiple the value by 100
            function(x) x*100) %>% 
  unite('state_county', county_name, state_name, sep = ', ', remove = FALSE) %>% 
  unite('full_fips', state, county, sep = '', remove = FALSE) %>% 
  filter(full_fips %in% (params$state_county)) %>% 
  arrange(factor(full_fips, levels = params$state_county)) %>% 
  mutate(state_county = gsub('County', '', state_county)) %>% 
  mutate(state_county = rm_white_comma(state_county)) 

#get the upward county - the first element in the parameter 
upward_county <- data %>% 
  filter(full_fips == params$state_county[1]) %>% 
  select(state_county) %>% 
  pull()


# get a full list of variables that are percentage 
perc_vars_lb <- purrr::map_chr(perc_vars, ~ paste0(., '_lb'))
perc_vars_ub <- purrr::map_chr(perc_vars, ~ paste0(., '_ub'))
lst <- list(perc_vars, perc_vars_lb, perc_vars_ub)
all_perc_vars <- sort(lst %>% reduce(c))

# filter to get the ones only existing in the data 
perc_vars_in_data <- all_perc_vars[(all_perc_vars %in% colnames(data))]


numeric_vars_one_digit <- data %>% 
  #select(-average_to_living_wage_ratio) %>% 
  select(-perc_vars_in_data) %>% 
  select_if(is.numeric) %>% 
  names()


data <- data %>% 
  #mutate_at(vars(matches('share_hs_degree_ub')),     #update ub for share_hs_degree to 1
  #          function(x) case_when(x > 1 ~ 1, 
  #                                TRUE  ~ x)) %>% 
  mutate_at(perc_vars_in_data,             #convert to percentage 
            function (x) scales::percent(x, accuracy = 0.1)) %>% 
  mutate_at(numeric_vars_one_digit, 
            function(x) {format(round(x, 1), big.mark=",",scientific=FALSE)}) %>% 
  mutate_at(vars(matches('average_to_living_wage_ratio')), 
            function(x) {format(round(x, 2), big.mark=",",scientific=FALSE)}) %>% 
  mutate(na_quality = 'NA')  %>%  #to be used for metrics where there is no quality variable %>% 
  mutate_at(vars(-one_of(c('state_county', 'subgroup'))), 
            function(x) gsub('\\s+', '', x)) %>%   #remove whitespace in values 
  #rename(hispanic_representation = hispanic,
  #       hispanic_representation_quality = hispanic_quality) %>% 
  mutate_at(vars(ends_with('_quality')), 
            function(x) recode(x, `1` = 'Good', `2` = 'Marginal', `3` = 'Poor')) 

note_ul_bound <- 'Lower/Upper bound'


```

# `r upward_county`

```{r}

get_vars_info <- function(varname, data_summary_file=m_info){
  
  info_lst <- data_summary_file %>% 
    filter(metric_name == varname) %>%
    purrr::transpose() %>% 
    simplify() %>%
    first()
  
  mb_vars <- info_lst[4][[1]]
  
  return(list(info_lst=info_lst, mb_vars=mb_vars))
}


unite_col_values <- function(df, colname_str){
  
  df <- df %>% 
    unite(!!sym(glue('{colname_str}_ci')), 
          glue('{colname_str}_lb'), 
          glue('{colname_str}_ub'), 
          sep = ', ', 
          remove=TRUE,
          na.rm = TRUE) %>% 
    mutate_at(vars(matches(glue('{colname_str}_ci'))), function(x) glue('({x})'))
  
  return(df)
}

```

```{r}


create_tb <- function(metrics_info_df, dataset, varname_maps){
  
  mb_metrics <- metrics_info_df$metric_name
  mb_vars  <- metrics_info_df$metric_vars_prefix[[1]]
  quality_var  <- metrics_info_df$quality_variable[[1]]
  metrics_desp  <- metrics_info_df$metrics_description
  data_source <- metrics_info_df$source_data
  subgroup_this_var <- metrics_info_df$subgroup_id
  col_from <- varname_maps[1][[1]]
  col_to <- varname_maps[2][[1]]
  
  temp <- dataset %>% 
    filter(subgroup_type == 'all') %>% 
    filter(subgroup_id == subgroup_this_var) %>% 
    select(matches(glue('{mb_vars}|{quality_var}|state_county'))) %>% 
    select(-matches('_lb|_ub')) %>% 
    select(sort(tidyselect::peek_vars())) %>% 
    rename_at(vars(all_of(col_from)), function(x) col_to) 
  
  if (str_detect(quality_var, '|') == FALSE){ #each variable has its own quality variable  
    
    temp <- temp %>% 
      relocate(!!sym(quality_var), .after = last_col())  
    
  } 
  
  temp %>% 
    pivot_longer(!state_county, names_to='metrics', values_to='value') %>%   
    pivot_wider(names_from = 'state_county', values_from = 'value') %>% 
    arrange(match(metrics, col_to)) %>% 
    mutate(metrics = gsub('.*_quality', 'Quality', metrics)) %>% 
    select(metrics, everything()) %>% 
    gt(rowname_col = 'metrics') %>% 
    tab_header(
      title = '', 
      subtitle = metrics_desp
    ) %>% 
    tab_source_note(str_c('Source:', data_source, sep=' ')) %>% 
    cols_align(
      align = 'left',
      columns = TRUE
    ) %>% 
    cols_align(
      align = 'left',
      columns = TRUE
    ) %>% 
    opt_align_table_header('left') %>% 
    tab_options(
      heading.title.font.size = tb_title_size, 
      heading.subtitle.font.size = tb_subtitle_size, 
      column_labels.font.size = tb_font_size,
      table.font.size = tb_font_size,
      source_notes.font.size = source_note_size, 
      table.width = pct(tb_width_perc), 
      table.align = tb_align) %>% 
    tab_style(
      style = list(
        cell_text(style = "italic")
      ),
      locations = cells_body(
        columns = TRUE,
        rows = metrics == 'Quality')
    )
}

```


```{r}


create_tb_level2 <- function(metrics_info_df, dataset, varname_maps){
  
  mb_metrics <- metrics_info_df$metric_name
  mb_vars  <- metrics_info_df$metric_vars_prefix[[1]]
  quality_var  <- metrics_info_df$quality_variable[[1]]
  metrics_desp  <- metrics_info_df$metrics_description
  data_source <- metrics_info_df$source_data
  subgroup_this_var <- metrics_info_df$subgroup_id
  ci_vars <- metrics_info_df$ci_var
  notes <- metrics_info_df$notes
  
  col_from <- varname_maps[3][[1]]
  col_to <- varname_maps[4][[1]]
  
  dataset <- dataset %>% 
    filter(subgroup_id == subgroup_this_var) %>% 
    filter(subgroup_type == 'all') 
  
  mb_vars_lst <- colnames(dataset %>% 
                            select(setdiff(matches(mb_vars),
                                           matches('_lb|_ub|_quality'))))
  
  if (ci_vars == 1){
    
    for (val in mb_vars_lst){      # update this to purrr 
      
      dataset <- unite_col_values(dataset, val)
      ci_str <- 'Confidence Interval'
      
    } 
    
    temp <- dataset %>% 
      select(matches(glue('{mb_vars}|{quality_var}|state_county')), -matches('_lb|ub'))
    
  } else if (ci_vars == 2){
    
    ci_str <- 'Confidence Interval*'   # *CI not available at this time.
    
    # create an empty df      #take this part out as a sep func 
    col_names <- glue('{mb_vars_lst}_ci')
    vec <- vector(mode = 'character', length = nrow(dataset) * length(mb_vars_lst))
    empty_ci_df <- as.data.frame(matrix(vec, c(nrow(dataset), length(mb_vars_lst))))
    colnames(empty_ci_df)[1:length(mb_vars_lst)] <- col_names
    
    temp <- dataset %>% 
      select(matches(glue('{mb_vars}|{quality_var}|state_county')), -matches('_lb|ub'))
    
    col_from <- col_from[-grep("*_ci", col_from)]
    col_to <- col_to[-grep("*ci", col_to)]
    
    notes <- paste(notes, 
                   'The Confidence Interval for this metrics is not available at this time.',
                   sep = '\n\n')
    
  } else if (ci_vars == 3){
    
    ci_str <- 'Confidence Interval+'   # '+CI not applicable.
    
    # create an empty df 
    col_names <- glue('{mb_vars_lst}_ci')
    vec <- vector(mode = 'character', length = nrow(dataset) * length(mb_vars_lst))
    empty_ci_df <- as.data.frame(matrix(vec, c(nrow(dataset), length(mb_vars_lst))))
    colnames(empty_ci_df)[1:length(mb_vars_lst)] <- col_names
    
    temp <- dataset %>% 
      select(matches(glue('{mb_vars}|{quality_var}|state_county')), -matches('_lb|ub'))
    
    col_from <- col_from[-grep("*_ci", col_from)]
    col_to <- col_to[-grep("*ci", col_to)]
    
    notes <- paste(notes, 
                   'The Confidence Interval for this metrics is not applicable.',
                   sep = '\n\n')
  }
  
  temp <- temp %>% 
    mutate_all(as.character) %>% 
    rename_at(vars(col_from), function(x) col_to)
  
  
  if (str_detect(quality_var, '|') == FALSE){ #each variable has its own quality variable  
    
    temp <- temp %>% 
      relocate(!!sym(quality_var), .after = last_col())  
    
  } 
  
  
  temp %>% 
    pivot_longer(!state_county, names_to='metrics', values_to='value') %>%
    pivot_wider(names_from = 'state_county', values_from = 'value') %>% 
    arrange(match(metrics, col_to)) %>% 
    mutate(metrics = gsub('.*ci', ci_str, metrics)) %>% 
    mutate(metrics = gsub('.*_quality', 'Quality', metrics)) %>% 
    select(metrics, everything()) %>% 
    gt(rowname_col = 'metrics') %>% 
    tab_header(
      title = '', 
      subtitle = metrics_desp
    ) %>% 
    tab_source_note(str_c('Source:', data_source, sep=' ')) %>% 
    tab_source_note(str_c('Notes:', notes, sep=' ')) %>% 
    cols_align(
      align = 'left',
      columns = TRUE
    ) %>% 
    cols_align(
      align = 'left',
      columns = TRUE
    ) %>% 
    opt_align_table_header('left') %>% 
    tab_options(
      heading.title.font.size = tb_title_size, 
      heading.subtitle.font.size = tb_subtitle_size, 
      column_labels.font.size = tb_font_size,
      table.font.size = tb_font_size,
      source_notes.font.size = source_note_size, 
      table.width = pct(tb_width_perc), 
      table.align = tb_align) %>% 
    tab_style(
      style = list(
        cell_text(style = "italic")
      ),
      locations = cells_body(
        columns = TRUE,
        rows = metrics == 'Quality')
    )
} 


gen_variable_name_map <- function(varname_maps){
  
  col_from <- varname_maps[3][[1]]
  col_to <- varname_maps[4][[1]]
  
  test <- map2(col_from, col_to, list)
  
  my_list <- list()
  
  for (i in list(1, length(test))){
    my_list[[ test[[i]][[1]] ]] <- test[[i]][[2]]
  }
  
  return(my_list)
}
```


```{r}


create_tb_level3 <- function(metrics_info_df, dataset, varname_maps){
  
  mb_metrics <- metrics_info_df$metric_name
  mb_vars  <- metrics_info_df$metric_vars_prefix[[1]]
  quality_var  <- metrics_info_df$quality_variable[[1]]
  metrics_desp  <- metrics_info_df$metrics_description
  data_source <- metrics_info_df$source_data
  subgroup_this_var <- metrics_info_df$subgroup_id
  ci_vars <- metrics_info_df$ci_var
  notes <- metrics_info_df$notes
  
  subgroup_varname <- 'subgroup'
  
  col_from <- varname_maps[3][[1]]
  col_to <- varname_maps[4][[1]]
  
  var_rename_lst <- gen_variable_name_map(varname_maps)
  
  dataset <- dataset %>% filter(subgroup_id == subgroup_this_var)
  
  mb_vars_lst <- colnames(dataset %>% 
                            select(setdiff(matches(mb_vars), matches('_lb|_ub|_quality'))))
  
  subgroup_type_name <- 'Group'
  
  var_selection <- function(my_ds){
    my_ds %>% 
      select(matches(glue('{mb_vars}|{quality_var}|{subgroup_varname}|state_county')), -matches('_lb|_ub')) %>% 
      select(-subgroup_type) %>% 
      rename(!!subgroup_type_name := subgroup)
  }
  
  if (ci_vars == 1){
    
    for (val in mb_vars_lst){      # update this to purrr 
      
      dataset <- unite_col_values(dataset, val)
      ci_str <- 'Confidence Interval'
    } 
    
    temp <- var_selection(dataset) 
    
    # display NA instead of (), if metrics and its CI for this subgroup is not avaiable 
    temp <- temp %>% mutate_at(vars(contains('ci')), ~ifelse((. == '()')|(. == '(NA, NA)'), NA, .))
    
  } else if (ci_vars == 2){
    
    ci_str <- 'Confidence Interval*'   # *CI not available at this time.
    
    # create an empty df      #take this part out as a sep func 
    col_names <- glue('{mb_vars_lst}_ci')
    vec <- vector(mode = 'character', length = nrow(dataset) * length(mb_vars_lst))
    empty_ci_df <- as.data.frame(matrix(vec, c(nrow(dataset), length(mb_vars_lst))))
    colnames(empty_ci_df)[1:length(mb_vars_lst)] <- col_names
    
    temp <- dataset %>%   
      select(matches(glue('state_county')))
    
    col_from <- col_from[-grep("*_ci", col_from)]
    col_to <- col_to[-grep("*ci", col_to)]
    
    notes <- paste(notes, 
                   'The Confidence Interval for this metrics is not available at this time.',
                   sep = '\n\n')
    
  } else if (ci_vars == 3){
    
    ci_str <- 'Confidence Interval+'   # '+CI not applicable.
    
    # create an empty df 
    col_names <- glue('{mb_vars_lst}_ci')
    vec <- vector(mode = 'character', length = nrow(dataset) * length(mb_vars_lst))
    empty_ci_df <- as.data.frame(matrix(vec, c(nrow(dataset), length(mb_vars_lst))))
    colnames(empty_ci_df)[1:length(mb_vars_lst)] <- col_names
    
    temp <- var_selection(dataset)
    
    col_from <- col_from[-grep("*_ci", col_from)]
    col_to <- col_to[-grep("*ci", col_to)]
    
    notes <- paste(notes, 
                   'The Confidence Interval for this metrics is not applicable.',
                   sep = '\n\n')
  }
  
  temp <- temp %>% 
    mutate_all(as.character) 
  
  if (str_detect(quality_var, '|') == FALSE){ #each variable has its own quality variable  
    
    temp <- temp %>% 
      relocate(!!sym(quality_var), .after = last_col())  
  } 
  
  temp %>% 
    pivot_longer(!c('state_county', 'subgroup_id', all_of(subgroup_type_name)), 
                 names_to='metrics', 
                 values_to='value') %>% 
    pivot_wider(names_from = 'state_county', 
                values_from = 'value') %>% 
    select(-subgroup_id) %>% 
    arrange(match(metrics, col_to)) %>% 
    #mutate(metrics = gsub('.*ci', ci_str, metrics)) %>% 
    mutate(metrics = gsub('.*_quality', 'Quality', metrics)) %>% 
    mutate(metrics = recode(metrics, !!!var_rename_lst)) %>% 
    select(metrics, everything()) %>% 
    gt(rowname_col = 'metrics') %>% 
    tab_header(
      title = '', 
      subtitle = metrics_desp
    ) %>% 
    tab_source_note(str_c('Source:', data_source, sep=' ')) %>% 
    tab_source_note(str_c('Notes:', notes, sep=' ')) %>% 
    cols_align(
      align = 'left',
      columns = TRUE
    ) %>% 
    cols_align(
      align = 'left',
      columns = TRUE
    ) %>% 
    opt_align_table_header('left') %>% 
    tab_options(
      heading.title.font.size = tb_title_size, 
      heading.subtitle.font.size = tb_subtitle_size, 
      column_labels.font.size = tb_font_size,
      table.font.size = tb_font_size,
      source_notes.font.size = source_note_size, 
      table.width = pct(tb_width_perc), 
      table.align = tb_align) %>% 
    tab_style(
      style = list(
        cell_text(style = "italic")
      ),
      locations = cells_body(
        columns = TRUE,
        rows = metrics == 'Quality')
    )
} 

```

<br><br>

## Driver:  Strong and Healthy Families

<br>

### Domain: Financial Well-Being 

<div class="exclude">*Visit [here](description.html#domain-financial-well-being) for a thorough description of the metrics in this domain.*</div>

#### Predictor: Income {.tabset .avoidpagebreak}

##### Summary

```{r}

income_varlist <- list(
  c(
    'pctl_20', 
    'pctl_50', 
    'pctl_80'
  ), 
  c(
    '20th Percentile', 
    '50th Percentile', 
    '80th Percentile'
  ), 
  c(
    'pctl_20', 
    'pctl_20_ci', 
    'pctl_50', 
    'pctl_50_ci', 
    'pctl_80',
    'pctl_80_ci'
  ), 
  c(
    '20th Percentile', 
    '20th Percentile ci', 
    '50th Percentile', 
    '50th Percentile ci', 
    '80th Percentile', 
    '80th Percentile ci'
  ) 
)


income_m_info_lst <- get_vars_info('Income')$info_lst
mb_vars <- get_vars_info('Income')$mb_vars

data_sub <- data %>% 
  mutate_at(vars(matches(mb_vars), -ends_with('_quality')), 
            function(x) gsub("\\..*","", glue('${x}')))


create_tb(metrics_info_df = income_m_info_lst, 
          dataset = data_sub, 
          varname_maps = income_varlist) 


```
<br>

##### Detail
```{r}

create_tb_level2(income_m_info_lst, data_sub, income_varlist)

```
<br>

#### Predictor: Financial security {.tabset .avoidpagebreak}

##### Summary

```{r}

debt_varlist <- list(
  c('share_debt_coll'),
  c('% with debt'), 
  c(
    'share_debt_coll', 
    'share_debt_coll_ci'
  ),
  c(
    '% with debt', 
    '% with debt ci')
)

m_info_lst <- get_vars_info('Financial security')$info_lst
mb_vars <- get_vars_info('Financial security')$mb_vars


create_tb(metrics_info_df = m_info_lst, 
          dataset = data, 
          varname_maps = debt_varlist) 


```

<br><br>

##### Detail

```{r}

create_tb_level2(metrics_info_df = m_info_lst, 
                 dataset = data, 
                 varname_maps = debt_varlist) 


```
<br><br>


##### Subgroup
```{r}

create_tb_level3(metrics_info_df = m_info_lst, 
                 dataset = data, 
                 varname_maps = debt_varlist) 

```


<br><br>

### Domain: Secure and Stable Housing {.printbreak}

<div class="exclude">*Visit [here](description.html#domain-housing) for a thorough description of the metrics in this domain.*</div>

#### Predictor: Affordable housing {.tabset .avoidpagebreak}

##### Summary

```{r}
housing_varlist <- list(
  c(
    'share_affordable_80_ami', 
    'share_affordable_50_ami'
  ), 
  c(
    'Ratio for low-income households', 
    'Ratio for very low-income households' 
  ), 
  c(
    'share_affordable_80_ami', 
    'share_affordable_80_ami_ci', 
    'share_affordable_50_ami',
    'share_affordable_50_ami_ci'
  ), 
  c('Ratio for low-income households', 
    'Ratio for low-income households ci', 
    'Ratio for very low-income households', 
    'Ratio for very low-income households ci' 
  )
)

af_m_info_lst <- get_vars_info('Affordable housing')$info_lst


create_tb(metrics_info_df = af_m_info_lst, 
          dataset = data, 
          varname_maps = housing_varlist) 

```

<br>

##### Detail

```{r}

create_tb_level2(metrics_info_df = af_m_info_lst, 
                 dataset = data, 
                 varname_maps = housing_varlist) 

```

<br>

#### Predictor: Housing instability and homelessness {.tabset .avoidpagebreak}

##### Summary

```{r}
housing_insta_varlist <- list(
  c(
    'homeless_count', 
    'homeless_share'
  ), 
  c(
    'Number homeless',
    'Share homeless'
  ),
  c(
    'homeless_count', 
    'homeless_count_ci', 
    'homeless_share'
  ), 
  c(
    'Number homeless',
    note_ul_bound, 
    'Share homeless'
  )
)

m_info_lst <- get_vars_info('Housing instability and homelessness')$info_lst


create_tb(metrics_info_df = m_info_lst, 
          dataset = data, 
          varname_maps = housing_insta_varlist) 

```

<br><br>

##### Detail
```{r}


create_tb_level2_homeless <- function(metrics_info_df, dataset, varname_maps){
  
  mb_metrics <- metrics_info_df$metric_name
  mb_vars  <- metrics_info_df$metric_vars_prefix[[1]]
  quality_var  <- metrics_info_df$quality_variable[[1]]
  metrics_desp  <- metrics_info_df$metrics_description
  data_source <- metrics_info_df$source_data
  ci_vars <- metrics_info_df$ci_var
  notes <- metrics_info_df$notes
  
  col_from <- varname_maps[3][[1]]
  col_to <- varname_maps[4][[1]]
  
  mb_vars_lst <- colnames(dataset %>% 
                            select(setdiff(matches(mb_vars),
                                           matches('_lb|_ub|_quality'))))
  
  for (val in mb_vars_lst){      # update this to purrr 
    
    if ((glue('{val}_lb') %in% colnames(dataset)) & (glue('{val}_ub') %in% colnames(dataset)))
      dataset <- unite_col_values(dataset, val)
    ci_str <- 'Confidence Interval'
    
  }
  
  notes <- paste(notes, 
                 'The Confidence Interval for Number Homeless is not applicable.',
                 sep = '\n\n')
  
  temp <- dataset %>% 
    select(matches(glue('{mb_vars}|{quality_var}|state_county')), -matches('_lb|ub')) %>% 
    mutate_all(as.character) %>% 
    rename_at(vars(col_from), function(x) col_to)
  
  temp %>% 
    pivot_longer(!state_county, names_to='metrics', values_to='value') %>%
    pivot_wider(names_from = 'state_county', values_from = 'value') %>% 
    arrange(match(metrics, col_to)) %>% 
    #mutate(metrics = gsub('.*ci', ci_str, metrics)) %>% 
    mutate(metrics = gsub('.*_quality', 'Quality', metrics)) %>% 
    select(metrics, everything()) %>% 
    gt(rowname_col = 'metrics') %>% 
    tab_header(
      title = '', 
      subtitle = metrics_desp
    ) %>% 
    tab_source_note(str_c('Source:', data_source, sep=' ')) %>% 
    tab_source_note(str_c('Notes:', notes, sep=' ')) %>% 
    cols_align(
      align = 'left',
      columns = TRUE
    ) %>% 
    cols_align(
      align = 'left',
      columns = TRUE
    ) %>% 
    opt_align_table_header('left') %>% 
    tab_options(
      heading.title.font.size = tb_title_size, 
      heading.subtitle.font.size = tb_subtitle_size, 
      column_labels.font.size = tb_font_size,
      table.font.size = tb_font_size,
      source_notes.font.size = source_note_size, 
      table.width = pct(tb_width_perc), 
      table.align = tb_align) %>% 
    tab_style(
      style = list(
        cell_text(style = "italic")
      ),
      locations = cells_body(
        columns = TRUE,
        rows = metrics == 'Quality')
    )
} 

create_tb_level2_homeless(metrics_info_df = m_info_lst, 
                          dataset = data, 
                          varname_maps = housing_insta_varlist) 

```

<br><br>

### Domain: Family Stability {.printbreak}

<div class="exclude">*Visit [here](description.html#domain-family-stability) for a thorough description of the metrics in this domain.*</div>

#### Predictor: Family structure and stability {.tabset .avoidpagebreak}

##### Summary

```{r}
famstruc_varlist <- list(
  c(
    'famstruc_2par_married', 
    'famstruc_2par_unmarried', 
    'famstruc_1par_plusadults', 
    'famstruc_1par_noadults',
    'famstruc_0par_2adults',	
    'famstruc_0par_other'
  ), 
  c(
    '% 2 married parents', 
    "% 1 parent and that parent's partner", 
    '% 1 parent and 1 other adult', 
    '% 1  parent',
    '% 2 adults, no parent',
    '% Other'
  ), 
  c(
    'famstruc_2par_married', 
    'famstruc_2par_married_ci',
    'famstruc_2par_unmarried', 
    'famstruc_2par_unmarried_ci',
    'famstruc_1par_plusadults', 
    'famstruc_1par_plusadults_ci', 
    'famstruc_1par_noadults',
    'famstruc_1par_noadults_ci',
    'famstruc_0par_2adults',	
    'famstruc_0par_2adults_ci',	
    'famstruc_0par_other',
    'famstruc_0par_other_ci'
  ), 
  c(
    '% 2 married parents', 
    '% 2 married parents ci', 
    "% 1 parent and that parent's partner", 
    "% 1 parent and that parent's partner ci",  
    '% 1 parent and 1 other adult', 
    '% 1 parent and 1 other adult ci', 
    '% 1  parent',
    '% 1  parent ci',
    '% 2 adults, no parent',
    '% 2 adults, no parent ci',
    '% Other', 
    '% Other ci'
  ) 
)

fss_m_info_lst <- get_vars_info('Family structure and stability')$info_lst


create_tb(metrics_info_df = fss_m_info_lst, 
          dataset = data, 
          varname_maps = famstruc_varlist) 

```
<br><br>

##### Detail
```{r}

create_tb_level2(metrics_info_df = fss_m_info_lst, 
                 dataset = data, 
                 varname_maps = famstruc_varlist) 


```
<br><br>


### Domain: Health {.printbreak}

<div class="exclude">*Visit [here](description.html#domain-health) for a thorough description of the metrics in this domain.*</div>

#### Predictor: Access to and utilization of health services {.tabset .avoidpagebreak}

##### Summary

```{r}
accuils_varlist <- list(
  c(
    'hpsa_yn'
  ), 
  c(
    'HPSA'
  ), 
  c(
    'hpsa_yn',
    'hpsa_yn_ci'
  ), 
  c(
    'HPSA',
    'HPSA ci'
  )
)

m_info_lst <- get_vars_info('Access to and utilization of health services')$info_lst


create_tb(metrics_info_df = m_info_lst, 
          dataset = data, 
          varname_maps = accuils_varlist) 


```
<br>

##### Detail

```{r}

create_tb_level2(metrics_info_df = m_info_lst, 
                 dataset = data, 
                 varname_maps = accuils_varlist) 


```
<br>

#### Predictor: Neonatal health {.tabset .avoidpagebreak}

##### Summary

```{r}

neonatal_varlist <- list(
  c('lbw'),
  c('% Low-weight birth'),
  c(
    'lbw', 
    'lbw_ci'
  ),
  c(
    '% Low-weight birth', 
    note_ul_bound)
)

nh_m_info_lst <- get_vars_info('Neonatal health')$info_lst

create_tb(metrics_info_df = nh_m_info_lst, 
          dataset = data, 
          varname_maps = neonatal_varlist) 

```
<br><br>

##### Detail

```{r}

create_tb_level2(metrics_info_df = nh_m_info_lst, 
                 dataset = data, 
                 varname_maps = neonatal_varlist) 

```
<br><br>

##### Subgroups

```{r}

create_tb_level3(metrics_info_df = nh_m_info_lst, 
                 dataset = data, 
                 varname_maps = neonatal_varlist) 

```


<br><br>

## Driver: Supportive Communities {.printbreak}

<br>

### Domain: Local Governance

<div class="exclude">*Visit [here](description.html#domain-local-governance) for a thorough description of the metrics in this domain.*</div>

#### Predictor: Political participation {.tabset .avoidpagebreak}

##### Summary

```{r}

election_turnout_varlist <- list(
  c('election_turnout'),
  c('% voting'),
  c(
    'election_turnout', 
    'election_turnout_ci'
  ),
  c(
    '% voting', 
    '% voting ci')
)

et_m_info_lst <- get_vars_info('Political participation')$info_lst



create_tb(metrics_info_df = et_m_info_lst, 
          dataset = data, 
          varname_maps = election_turnout_varlist) 


```
<br>


##### Detail
```{r}

create_tb_level2(metrics_info_df = et_m_info_lst, 
                 dataset = data, 
                 varname_maps = election_turnout_varlist) 

```
<br>

### Domain: Neighborhoods {.printbreak}

<div class="exclude">*Visit [here](description.html#domain-neighborhoods) for a thorough description of the metrics in this domain.*</div>

#### Predictor: Economic inclusion {.tabset .avoidpagebreak}

##### Summary

```{r}
econ_inc_varlist <- list(
  c('poverty_exposure'),
  c('% in high poverty neighborhoods'),
  c(
    'poverty_exposure', 
    'poverty_exposure_ci'
  ),
  c(
    '% in high poverty neighborhoods', 
    '% in high poverty neighborhoods ci')
)

ei_m_info_lst <- get_vars_info('Economic inclusion')$info_lst


create_tb(metrics_info_df = ei_m_info_lst, 
          dataset = data, 
          varname_maps = econ_inc_varlist) 


```
<br>


##### Detail
```{r}

create_tb_level2(metrics_info_df = ei_m_info_lst, 
                 dataset = data, 
                 varname_maps = econ_inc_varlist) 

```

<br>

#### Predictor: Racial diversity {.tabset  .avoidpagebreak}

##### Summary
```{r}

race_div <- list(
  c('white_nh_exposure',
    'white_nh_exposure_quality', 
    'black_nh_exposure',
    'black_nh_exposure_quality', 
    'hispanic_exposure',
    'hispanic_exposure_quality'),
  c('% for Non-Black, Non-Hispanic', 
    '% for Non-Black, Non-Hispanic_quality', 
    '% for Black, Non-Hispanic', 
    '% for Black, Non-Hispanic_quality', 
    '% for Hispanic', 
    '% for Hispanic_quality'
  ),
  c('white_nh_exposure',
    'white_nh_exposure_ci',
    'white_nh_exposure_quality', 
    'black_nh_exposure',
    'black_nh_exposure_ci',
    'black_nh_exposure_quality', 
    'hispanic_exposure',
    'hispanic_exposure_ci',
    'hispanic_exposure_quality'),
  c('% for Non-Black, Non-Hispanic', 
    '% for Non-Black, Non-Hispanic_ci', 
    '% for Non-Black, Non-Hispanic_quality',
    '% for Black, Non-Hispanic', 
    '% for Black, Non-Hispanic_ci',
    '% for Black, Non-Hispanic_quality', 
    '% for Hispanic', 
    '% for Hispanic_ci', 
    '% for Hispanic_quality'
  )
)

rd_m_info_lst <- get_vars_info('Racial diversity')$info_lst

create_tb(metrics_info_df = rd_m_info_lst, 
          dataset = data, 
          varname_maps = race_div) 



```
<br>


##### Detail
```{r}

create_tb_level2(metrics_info_df = rd_m_info_lst, 
                 dataset = data, 
                 varname_maps = race_div) 

```

<br>

#### Predictor: Transportation access {.tabset .avoidpagebreak}

##### Summary {.avoidpagebreak}

```{r}
trans_access <- list(
  c('transit_trips'),
  c('Transit trips'),
  c(
    'transit_trips', 
    'transit_trips_ci'
  ),
  c(
    'Transit trips', 
    'Transit trips ci')
)

trans_info_lst <- get_vars_info('Transportation access')$info_lst

create_tb(metrics_info_df = trans_info_lst, 
          dataset = data, 
          varname_maps = trans_access) 

```
<br>

##### Detail
```{r}

create_tb_level2(metrics_info_df = trans_info_lst, 
                 dataset = data, 
                 varname_maps = trans_access) 

```
##### Subgroup

```{r}

create_tb_level3(metrics_info_df = trans_info_lst, 
                 dataset = data, 
                 varname_maps = trans_access) 

```

<br>

####  {.tabset}

##### Summary {.avoidpagebreak}
```{r}


trans_cost_varlist <- list(
  c('transit_cost'),
  c('Transit cost'),
  c(
    'transit_cost', 
    'transit_cost_ci'
  ),
  c(
    'Transit cost', 
    'Transit cost ci')
)

tr_cost_m_info_lst <- get_vars_info('Transportation access-cost')$info_lst


create_tb(metrics_info_df = tr_cost_m_info_lst, 
          dataset = data, 
          varname_maps = trans_cost_varlist) 


```
<br>


##### Detail
```{r}

create_tb_level2(metrics_info_df = tr_cost_m_info_lst, 
                 dataset = data, 
                 varname_maps = trans_cost_varlist) 


```

##### Subgroup

```{r}

create_tb_level3(metrics_info_df = tr_cost_m_info_lst, 
                 dataset = data, 
                 varname_maps = trans_cost_varlist) 

```


<br>

#### Predictor: Environmental quality {.tabset .avoidpagebreak}

##### Summary

```{r}
env_varlist <- list(
  c('haz_idx'),
  c('Air quality index'),
  c(
    'haz_idx', 
    'haz_idx_ci'
  ),
  c(
    'Air quality index', 
    'Air quality index ci')
)

env_m_info_lst <- get_vars_info('Environmental quality')$info_lst


create_tb(metrics_info_df = env_m_info_lst, 
          dataset = data, 
          varname_maps = env_varlist) 


```
<br><br>


##### Detail
```{r}

create_tb_level2(metrics_info_df = env_m_info_lst, 
                 dataset = data, 
                 varname_maps = env_varlist) 


```
<br><br>

### Domain: Safety {.printbreak}

<div class="exclude">*Visit [here](description.html#domain-safety) for a thorough description of the metrics in this domain.*</div>

#### Predictor: Exposure to crime {.tabset .avoidpagebreak}

##### Summary

```{r}
exp_crime_varlist <- list(
  c(
    'violent_crime_rate',
    'property_crime_rate'
  ),
  c(
    'Violent crime', 
    'Property crime'
  ),
  c(
    'violent_crime_rate',
    'violent_crime_rate_ci', 
    'property_crime_rate',
    'property_crime_rate_ci'
  ),
  c(
    'Violent crime', 
    'Violent crime ci', 
    'Property crime', 
    'Property crime ci'
  )
)

ec_m_info_lst <- get_vars_info('Exposure to crime')$info_lst
mb_vars <- get_vars_info('Exposure to crime')$mb_vars

data_sub_exp_crime <- data %>% 
  mutate_at(vars(matches(mb_vars), -ends_with('_quality')), 
            function(x) gsub("\\..*","", x))


create_tb(metrics_info_df = ec_m_info_lst, 
          dataset = data_sub_exp_crime, 
          varname_maps = exp_crime_varlist) 



```
<br>


##### Detail
```{r}

create_tb_level2(metrics_info_df = ec_m_info_lst, 
                 dataset = data_sub_exp_crime, 
                 varname_maps = exp_crime_varlist) 



```
<br>

#### Predictor: Overly punitive policing {.tabset .avoidpagebreak}

##### Summary
```{r}


punative_policing <- list(
  c('juvenile_arrest_rate'),
  c('Juvenile arrests'),
  c(
    'juvenile_arrest_rate', 
    'juvenile_arrest_rate_ci'
  ),
  c(
    'Juvenile arrests', 
    'Juvenile arrests ci')
)

m_info_lst <- get_vars_info('Overly punitive policing')$info_lst
mb_vars <- get_vars_info('Overly punitive policing')$mb_vars

data_sub_punitive <- data %>% 
  mutate_at(vars(matches(mb_vars), -ends_with('_quality')), 
            function(x) gsub("\\..*","", x))


create_tb(metrics_info_df = m_info_lst, 
          dataset = data_sub_punitive, 
          varname_maps = punative_policing) 



```
<br><br>


##### Detail
```{r}

create_tb_level2(metrics_info_df = m_info_lst, 
                 dataset = data_sub_punitive, 
                 varname_maps = punative_policing) 


```

<br><br>

## Driver: Opportunities to Learn and Earn {.printbreak}

<br>

### Domain: Education

<div class="exclude">*Visit [here](description.html#domain-education) for a thorough description of the metrics in this domain.*</div>

#### Predictor: Access to preschool {.tabset .avoidpagebreak}

##### Summary

```{r}
share_in_presch_varlist <- list(
  c('share_in_preschool'),
  c('% Pre-kindergarten'),
  c(
    'share_in_preschool', 
    'share_in_preschool_ci'
  ),
  c(
    '% Pre-kindergarten', 
    '% Pre-kindergarten ci')
)

ap_m_info_lst <- get_vars_info('Access to preschool')$info_lst


create_tb(metrics_info_df = ap_m_info_lst, 
          dataset = data, 
          varname_maps = share_in_presch_varlist) 


```
<br>


##### Detail
```{r}

create_tb_level2(metrics_info_df = ap_m_info_lst, 
                 dataset = data, 
                 varname_maps = share_in_presch_varlist) 


```
<br>

#### Predictor: Effective public education {.tabset .avoidpagebreak}

##### Summary

```{r}

eff_pub_ed <- list(
  c('learning_rate'),
  c('Annual ELA achievement'),
  c(
    'learning_rate', 
    'learning_rate_ci'
  ),
  c(
    'Annual ELA achievement', 
    note_ul_bound)
)


epd_m_info_lst <- get_vars_info('Effective public education')$info_lst

create_tb(metrics_info_df = epd_m_info_lst, 
          dataset = data, 
          varname_maps = eff_pub_ed) 

```
<br>


##### Detail
```{r}


create_tb_level2(metrics_info_df = epd_m_info_lst, 
                 dataset = data, 
                 varname_maps = eff_pub_ed) 

```

<br>

##### Subgroup
```{r}

create_tb_level3(metrics_info_df = epd_m_info_lst, 
                 dataset = data, 
                 varname_maps = eff_pub_ed) 

```

<br>

#### Predictor: Student poverty concentration {.tabset  .avoidpagebreak}

##### Summary

```{r}

stu_poverty <- list(
  c('frpl40_white', 
    'frpl40_white_quality',
    'frpl40_black',
    'frpl40_black_quality',
    'frpl40_hispanic', 
    'frpl40_hispanic_quality'
  ),
  c(
    '% for White, non-Hispanic', 
    '% for White, non-Hispanic_quality',
    '% for Black, non-Hispanic', 
    '% for Black, non-Hispanic_quality', 
    '% for Hispanic', 
    '% for Hispanic_quality'
  ),
  c('frpl40_white', 
    'frpl40_white_ci', 
    'frpl40_white_quality',
    'frpl40_black',
    'frpl40_black_ci', 
    'frpl40_black_quality',
    'frpl40_hispanic', 
    'frpl40_hispanic_ci',
    'frpl40_hispanic_quality'
  ),
  c(
    '% for White, non-Hispanic', 
    '% for White, non-Hispanic_ci', 
    '% for White, non-Hispanic_quality',
    '% for Black, non-Hispanic', 
    '% for Black, non-Hispanic_ci',
    '% for Black, non-Hispanic_quality', 
    '% for Hispanic', 
    '% for Hispanic_ci',
    '% for Hispanic_quality'
  )
)


spoverty_m_info_lst <- get_vars_info('Student poverty concentration')$info_lst

create_tb(metrics_info_df = spoverty_m_info_lst, 
          dataset = data, 
          varname_maps = stu_poverty) 

```
<br>


##### Detail
```{r}


create_tb_level2(metrics_info_df = spoverty_m_info_lst, 
                 dataset = data, 
                 varname_maps = stu_poverty) 

```
<br>

#### Predictor: College readiness {.tabset .avoidpagebreak}

##### Summary

```{r}
college_readiness <- list(
  c('share_hs_degree'),
  c('% HS degree'),
  c(
    'share_hs_degree', 
    'share_hs_degree_ci'
  ),
  c(
    '% HS degree', 
    '% HS degree ci')
)

m_info_lst <- get_vars_info('College readiness')$info_lst


create_tb(metrics_info_df = m_info_lst, 
          dataset = data, 
          varname_maps = college_readiness) 


```
<br><br>


##### Detail
```{r}

create_tb_level2(metrics_info_df = m_info_lst, 
                 dataset = data, 
                 varname_maps = college_readiness) 

```

<br><br>

### Domain: Work {.printbreak}

<div class="exclude">*Visit [here](description.html#domain-work) for a thorough description of the metrics in this domain.*</div>

#### Predictor: Employment {.tabset .avoidpagebreak}

##### Summary

```{r}
emp_lst <- list(
  c('share_employed'),
  c('Employment to population ratio'),
  c(
    'share_employed', 
    'share_employed_ci'
  ),
  c(
    'Employment to population ratio', 
    'Employment to population ratio ci')
)


emp_m_info_lst <- get_vars_info('Employment')$info_lst


create_tb(metrics_info_df = emp_m_info_lst, 
          dataset = data, 
          varname_maps = emp_lst) 


```
<br>


##### Detail
```{r}

create_tb_level2(metrics_info_df = emp_m_info_lst, 
                 dataset = data, 
                 varname_maps = emp_lst) 

```

<br>

#### Predictor: Access to jobs paying a living wage {.tabset .avoidpagebreak}

##### Summary

```{r}
job_wage <- list(
  c('average_to_living_wage_ratio'),
  c('Ratio of pay to living wage'),
  c(
    'average_to_living_wage_ratio', 
    'average_to_living_wage_ratio_ci'
  ),
  c(
    'Ratio of pay to living wage', 
    'Ratio of pay to living wage ci')
)


m_info_lst <- get_vars_info('Access to jobs paying a living wage')$info_lst

create_tb(metrics_info_df = m_info_lst, 
          dataset = data, 
          varname_maps = job_wage) 


```
<br><br>


##### Detail
```{r}

create_tb_level2(metrics_info_df = m_info_lst, 
                 dataset = data, 
                 varname_maps = job_wage) 


```
<br><br>


## Notes on Data Quality
| "Good" indicates that the metric is measured with adequate accuracy and sample size.
| "Marginal" indicates that there are known shortcomings of the data for this metric for this county, and the metric should be used with caution.
| "Poor" indicates that although the metric could be computed for this county, we have serious concerns about how accurately it is measured for this county and do not recommend its use.

<br><br>


## Additional Notes {.printbreak}

The following metrics require original data collection: 

* **Overall health:** Share of adults who rate their own and their children’s health as good or excellent
* **Belongingness:** Inclusion of other in the self scale
* **Social Capital:** Social capital community benchmark scale
* **Exposure to Trauma:** Adverse childhood experiences scale
* **Descriptive representation among local officials:** The ratio of the share of the city council or county board from specific racial and ethnic groups and the share of city or county residents from those racial or ethnic groups

<br>

| Confidence intervals shown are 95 percent.
| * This confidence interval is not available at this time.
| + A confidence interval is not applicable.
| Lower/Upper bound:  The data used to construct this metric do not lend themselves to conventional confidence intervals. The value of the metric shown represents are best estimate; the lower and upper bounds represent alternative estimates of the metric under different assumptions about missing data.


