---
title: "test_copy"
format: html
editor: visual
---

This quarto document is intended to test whether all of the files created on an ec2 instance were successfully copied from the volume on that instance to S3. The script that performs the copy operation is `aws_cp_command.sh`.

The first two tests are intended to be run *after* the files are copied and can be run locally (as long as the user running the commands has CLI access to AWS). The last test is intended to be run on the EC2 instance to ensure that correct number of files were generated.

## Test 1: Count the number of files in

```{r}
library(aws.s3)
library(tidyverse)
```

This script creates a `count.csv` file that has a column "count" with the first variable being the number of counties in the s3 bucket and the second bing the number of places.

```{bash}
echo "count" > count.csv
aws s3 ls s3://mobility-metrics-data-pages-dev/999_county-pages/ | wc -l >> count.csv
aws s3 ls s3://mobility-metrics-data-pages-dev/998_place-pages/ | wc -l >> count.csv
```

```{r}
library(tidyverse)
count <- read_csv("count.csv")
counties_count <- count[1, 1] %>% 
  pull(count)

places_count <- count[2, 1] %>%
  pull(count)

stopifnot(counties_count == 3143)
stopifnot(places_count == 486)

```

##Test 2: 
This test looks to see that the last file that was copied in the county and place sub-directories. This is more of a "sniff test" but the dates and times should make sense based on the current run, and the last files should be in late folders (e.g. state fips codes should be 56). 


```{bash}

aws s3 ls s3://mobility-metrics-data-pages-dev/999_county-pages/ --recursive | sort | tail -n 1 
```

```{bash}
aws s3 ls s3://mobility-metrics-data-pages-dev/998_place-pages/ --recursive | sort | tail -n 1 
```

\`\``## Test 3:  To ensure that all of the files are created, we can count the number of files called`index.html`on the EC2 instance in each of the sub-directories. Specifically, you can run:

`find factsheets/999_county-pages/ -type f -name 'index.html' \| wc -l\`

`find factsheets/998_place-pages/ -type f -name 'index.html' | wc -l`
